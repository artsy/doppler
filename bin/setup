#!/bin/bash

# This assumes you have general prerequisites installed as by:
# https://github.com/artsy/potential/blob/main/scripts/setup

# Exit if any subcommand fails
set -e

if command -v asdf >/dev/null; then
  echo "Installing language dependencies with asdf"
  asdf install
else
  echo "Skipping language dependencies installation (asdf not found)"
fi

echo "Downloading .env.shared (for common local dev config)..."
aws s3 cp s3://artsy-citadel/doppler/.env.shared ./

echo "Installing prerequisite gems..."

# Install a compatible version of rubygems-update
gem install rubygems-update -v 3.3.26 && update_rubygems


if [ ! -e ".env" ]; then
  echo "Initializing .env from .env.example (for any custom configuration)..."
  cp .env.example .env
fi

echo "Installing gems..."
bundle install

echo "
Done!

Your local dev environment is setup with common config in .env.shared. You can override them in .env.

You should be able to run some tests, as in:

    bundle exec rspec spec/requests

To start a local server (at http://localhost:3000):

    foreman start
"
